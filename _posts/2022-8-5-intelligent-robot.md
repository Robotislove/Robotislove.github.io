---
layout: post
title: 智能服务机器人3D-SLAM优化汇总
date: 2022-08-5
author: lau
tags: [SLAM,Archive]
comments: true
toc: true
pinned: false
---
智能服务机器人3D-SLAM优化。

<!-- more -->

## 摘要

在目前开源方案里，能够同时融合gps、imu、lidar等多种传感器的激光SLAM框架还比较少。cartographer算是一种，但相对来说，hdl_graph_slam在资源消耗、代码复杂度、建图流程等方面具有较大优势，本文针对其后端优化模块阐述相关知识点、算法结构，及代码解读。

### 1.介绍

hdl-graph-slam是一个非常优秀的3d 激光SLAM框架，不仅融合了imu、gps、平面、激光等多种输入，同时也带闭环检测等后端处理，即完整的一个slam架构。其功能较为全面，包括平面检测及提取、点云预处理、激光里程计、闭环检测、GPS和IMU数据融合、后端图优化等等。

#### 1.1 框架流程

![](http://image.huawei.com/tiny-lts/v1/images/84054e2b9361279a179c7e7d3875cbe4_784x167.jpg@900-0-90-f.jpg)

首先读入激光雷达的点云数据，然后将原始的点云数据进行预滤波，经过滤波后的数据分别给到点云匹配里程计及地面检测节点，两个节点分别计算连续两帧的相对运动和检测到的地面的参数，并将这两种消息送到hdl_graph_slam节点进行位姿图的更新及回环检测，并发布地图的点云数据。算法框架采用eigen、pcl、g2o等开源库。

**地面检测**

当所处的环境中地面为平面时，它就可以作为一个很有效的信息去约束高程的误差。在没有gps的情况下，高程误差是主要的误差项。当然在地面为非平面的时候是不能够使用的，在使用时根据环境决定是否开启这项功能。

**地图精度**

激光SLAM在构建地图的时候，精度较高，一般可达到2cm左右；VSLAM，比如常见的深度摄像机Kinect(测距范围在3-12m之间)，地图构建精度约3cm；所以激光SLAM构建的地图精度一般来说比VSLAM高，且能直接用于定位导航。

### 2. 基础知识

本章节整理了一些与3D SLAM 后优化相关的必需掌握的基础知识点，供参考。

#### 2.1 非线性优化
##### 2.1.1 高斯牛顿法
GN(Gauss-Newton)是优化算法里最简单的方法之一，思想是将$f(x)$进行一阶的泰勒展开。

$$
f(x+\Delta x) \approx f(x)+J(x) \Delta x
$$
其中$J(x)$为$f(x)$在$x$的导数，是一个雅克比矩阵。当前的目标是为了寻找下降矢量$\Delta x$，使得\|f(\boldsymbol{x}+\Delta \boldsymbol{x})\|^{2}达到最小。为了求$\Delta x$需要求解一个线性最小二乘问题：

$$
\Delta {x}^{*} =\arg \min_{\Delta \boldsymbol{x}} \frac{1}{2}\|f(\boldsymbol{x})+\boldsymbol{J}(\boldsymbol{x}) \Delta \boldsymbol{x}\|^{2}
$$

根据极值条件，将上述目标函数对求导，并令其导数为零。由于这里考虑的是的导数而不是$x$,最后将得到一个线性方程。

![](http://image.huawei.com/tiny-lts/v1/images/59c0fcbe7ec53434b985255d30f4e24e_626x268.png@900-0-90-f.png)

注，此处要求解的变量是$\Delta$，因此这是一个线性方程组,我们称为增量方程，也叫高斯牛顿方程，也叫正规方程。把左边系数定义为H，右边定义为g,则上式变为：$H\Delta=g$。这里把左侧记做 H 是有意义的，对比牛顿法。 GN用$J^TJ$作为牛顿法中的二阶Hession。从而省略H的过程。求解增量方程式整个优化问题的核心所在。

如果能顺利求解次方程，那么GN算法步骤如下：
![](http://image.huawei.com/tiny-lts/v1/images/09ed4bcf96f8c56d82524275da5c8f7b_561x167.png@900-0-90-f.png)

![](http://image.huawei.com/tiny-lts/v1/images/977b990d0d525f1748dcdd739fb3cd52_598x201.png)

##### 2.1.2 Levenberg-Marquadt

LM方法在一定程度上修正了这些问题，一般认为它比GN更为鲁棒。尽管它的收敛速度可能比GN慢，被称之为阻尼牛顿法.由于GN中采用近似的二阶泰勒展开只能在展开点附近有较好的近似效果，所以很自然的想到应该给添加一个信赖区域，不能让它太大使得近似不准确。非线性优化有一系列这类方法，也被称之为信赖区域方法。在信赖区域里面，认为近似是有效的，出了这个区域，近似可能会出问题。

那么如何确认这个信赖区域的范围？一个比较好的方法是根据近似模型跟实际函数之间的差异来确定。如果差异够小，就让范围尽可能大。如果差异大，就缩小这个近似范围。因此，可以考虑使用
![](http://image.huawei.com/tiny-lts/v1/images/768c82a7a8e6975fec3ad145723d0c7d_281x72.png@900-0-90-f.png)

来判断泰勒近似是否够好，$\rho$的分子式实际函数下降的值，分母是近似模型下降的值。如果接近于1，则近似是好的。如果太小，说明实际减小的值远少于近似减少的值，这认为近似比较差。反之，如果比较大，则说明实际下降的比预计的更大，可以放大近似范围。

##### 2.1.3 小结

实际中还存在许多其他方式来求解函数增量，例如Dog-Leg等。以上2种也是视觉SLAM 中用的最多的方式。总的来说，非线性优化问题的框架可分为Line Search 和Trust Region 两类。Line Search 先固定搜索方向，然后在该方向寻找步长，以最速下降法和GN法为代表。而Trust Region则先固定搜索区域，再考虑找该区域内的最优点。此类方法以L-M为代表。实际问题中，通常选择GN或L-M之一作为梯度下降策略。

#### 2.2 Eigen库

Eigen是一个高层次的C++开源库，有效支持线性代数，矩阵和矢量运算，数值分析及其相关的算法。从3.1.1版本开始遵从MPL2许可，除了C++标准库以外，无任何其他依赖包。使用CMake建立配置文件和单元测试，并自动安装。如果使用Eigen库，只需包括特定模块的的头文件即可。

Eigen支持包括固定大小、任意大小的所有矩阵操作，甚至是稀疏矩阵；支持所有标准的数值类型，并且可以扩展为自定义的数值类型；支持多种矩阵分解及其几何特征的求解；它为支持的模块生态系统提供了许多专门的功能，如非线性优化，矩阵功能，多项式解算器，快速傅立叶变换等。

#### 2.3 图优化
图优化是一种将非线性优化和图论结合起来的理论。
##### 2.3.1 图优化介绍

图优化里的图就是数据结构里的图，一个图由若干个顶点(vertex)，以及连接这些顶点的边（edge）组成。比如一个机器人在房屋里移动，它在某个时刻 $t$ 的位姿（pose）就是一个顶点，这个也是待优化的变量。而位姿之间的关系就构成了一个边，比如时刻 $t$ 和时刻 $t+1$ 之间的相对位姿变换矩阵就是边，边通常表示误差项。

在SLAM优化问题中，经常求解一个代价函数：

![](http://image.huawei.com/tiny-lts/v1/images/94500b62286e465e14636bd81f96a502_524x100.png@900-0-90-f.png)

可以理解，图优化就是这个代价函数的求解问题，待优化的位姿和地图点就是图的顶点，而误差项是图的边。

在SLAM里，图优化一般分解为两个任务：

1、构建图：机器人位姿作为顶点，位姿间关系作为边。

2、优化图：调整机器人的位姿（顶点）来尽量满足边的约束，使得误差最小。

##### 2.3.2 图优化优势

在SLAM后端算法领域，一般分为两种处理方法，一种是以扩展卡尔曼滤波(EKF)的方法为代表；一种是基于非线性优化的方法，以图优化为代表。现在主流是图优化的方法，因为其可以把SLAM系统的历史状态量和路标点位置考虑进去一起优化，大大提高了轨迹和地图的精度。

在以图优化框架的视觉SLAM算法里，BA(Bundle Adjustment光束平差法、捆集调整)起到了核心作用。基于视觉的SLAM方案，路标点(特征点)数据很大，意味着BA求解的计算量也很大，没法做到实时。研究人员发现，虽然视觉SLAM问题中包含大量特征点和相机位姿，但BA有着稀疏的特性，使得它能够在实时的场景中使用。这也是图优化成为主流方法的原因！

#### 2.4 g2o图优化

![](http://image.huawei.com/tiny-lts/v1/images/2fc333ab9e59c649790d55c6a7f86aad_779x411.jpg@900-0-90-f.jpg)

优化的目的是为了通过当前已知的系统理想化的模型和实际测量的数据获取最接近真实值的系统结果。滤波方法和图优化方案解决的问题都是对不可靠的测量值进行处理以获取尽可能接近真实值的结果。以卡尔曼滤波器为例，在进行操作之前需要有一个相对靠谱的预测模型用来获取先验(预测)信息，以及实时的测量数据用来矫正预测信息。

g2o图优化则是将优化问题和图论相结合，最典型的作用就是将待优化问题通过测量的数据建立最小二乘并将该最小二乘问题通过图论中的边的顶点表示出来，之后调用g2o库通过求解对应的图来实现对最小二乘问题的求解以达到优化的目的。其中图优化中的点表示待优化变量，如(ＸＹＺ)；边表示误差，边依赖于点的存在而存在，边可能和一个点、俩个点、多个点相连，每条边都表示与之相连的点之间的误差。在SLAM问题中以相机位姿和观测到的路标做点，点与点之间存在的误差（重投影误差、相机位姿估计误差）做边。图优化示例：
![](http://image.huawei.com/tiny-lts/v1/images/26a99177edd22637a7df924155413f23_576x321.png@900-0-90-f.png)

注：g2o是比较流行的图优化库，在视觉slam中的应用非常广泛。只要是能把优化问题表示成顶点和边的形式，就可以非常容易的调用g2o来进行优化。

##### 2.4.1 g2o使用步骤

使用步骤主要分成以下四部分：

1) 点和边的类型定义；

2) 构建图优化实例，配置求解器；

3) 添加点和边，构建求解图；

4) 执行优化操作。

##### 2.4.2 g2o整体结构

![](http://image.huawei.com/tiny-lts/v1/images/c944cd6a77b35b8a9628d2476e4af046_783x463.png@900-0-90-f.png)

从图中可看出整个库里较为重要的类之间的继承以及包含关系，及整个框架里面最重要的SparseOptimizer这个类（或实例）。

**Vertex和Edge**

所使用的优化器最终是一个超图（hyperGrahp），而这个超图包含了许多顶点和边。在图优化中，顶点代表了要被优化的变量，而边则是连接被优化变量的桥梁。在整个优化过程中，顶点的值会越来越趋近于最优值，优化完毕后则可以将顶点的优化值作为最优值进行使用；边则是连接顶点的类型，在SLAM问题中，一般是边连接要被优化的空间点(Point)和机器人的位姿(Pose)，当然，边还可以连接一个顶点（类似于参数估计，边的数量由量测的数量决定），也可以连接多个顶点，边在图优化中的一个很大的作用就是计算误差（视觉SLAM中计算的就是空间点的映射误差），同时计算该误差对于被优化变量的jacobian矩阵，也是比较重要的存在。

注：用g2o的时候，总会遇到自己独特的顶点类型和边类型，此时需要对顶点和边进行重写。

##### 2.4.3 g2o优化算法

涉及到优化的算法，块求解器，线性求解器等部分，在程序中，这部分通常位于g2o算法的开头配置部分，一般情况下可以随着一个例程进行配置即可。







